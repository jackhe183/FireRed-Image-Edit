# FireRed-Image-Edit 项目学习笔记

> 创建时间: 2026-02-13
> 项目路径: `C:/Users/root/Desktop/FireRed-Image-Edit-main`

## 一、项目概述

**FireRed-Image-Edit** 是一个通用图像编辑模型，基于 Diffusers 框架的 `QwenImageEditPlusPipeline` 构建。

### 项目特点
- **推理项目**，非训练项目
- 代码量少（核心推理约 100 行）
- 依赖外部预训练模型（HuggingFace Hub）

## 二、环境配置（Windows + uv）

### 1. 创建隔离环境
```bash
cd "C:/Users/root/Desktop/FireRed-Image-Edit-main"
uv venv .venv
```

### 2. 安装依赖
```bash
# 基础依赖
uv pip install --python .venv/Scripts/python.exe torch torchvision Pillow accelerate google-generativeai tqdm

# Diffusers 和相关库
uv pip install --python .venv/Scripts/python.exe diffusers transformers
```

## 三、核心架构分析

### 1. 代码结构

```
FireRed-Image-Edit-main/
├── inference.py              # 单图推理入口
├── tools/
│   ├── redbench_infer.py   # 批量推理（评测用）
│   └── redbench_eval.py    # Gemini API 评估
├── examples/
│   └── *.png              # 示例图片
└── assets/
    └── architecture.png      # 模型架构图
```

### 2. 推理流程

```
输入层
  ├── 原图 (PIL Image)
  ├── 编辑指令 (prompt, 中英文)
  └── 参数 (seed, cfg_scale, steps)
         ↓
核心层: QwenImageEditPlusPipeline (Diffusers)
  ├── 从 HuggingFace 下载模型
  ├── 加载到 GPU (CUDA)
  └── 执行扩散推理
         ↓
输出层
  └── 编辑后的图片 (保存为 PNG)
```

### 3. 关键参数说明

| 参数 | 默认值 | 作用 |
|-----|--------|-----|
| `model_path` | `FireRedTeam/FireRed-Image-Edit-1.0` | HuggingFace 模型 ID |
| `true_cfg_scale` | 4.0 | True CFG scale，控制指令跟随强度 |
| `guidance_scale` | 1.0 | 标准 CFG scale |
| `num_inference_steps` | 40 | 推理步数，影响质量/速度 |
| `torch_dtype` | bfloat16 | GPU 优化的半精度 |

## 四、运行要求

### 必需条件
- ✅ NVIDIA GPU
- ✅ CUDA 环境
- ✅ 足够显存（推荐 8GB+）
- ❌ CPU 不支持（代码硬编码 `pipe.to("cuda")`）

### 模型状态
- 当前状态：**"To be released"**（未发布）
- 无法从 HuggingFace 下载
- 需要 HuggingFace 访问权限（私有或 gated 模型）

## 五、命令示例

### 单图推理
```bash
uv run --python .venv/Scripts/python.exe inference.py \
    --input_image ./examples/edit_example.png \
    --prompt "在书本封面Python的下方，添加一行英文文字2nd Edition" \
    --output_image output_edit.png \
    --seed 43
```

### 批量推理（RedBench 评测）
```bash
uv run --python .venv/Scripts/python.exe tools/redbench_infer.py \
    --model-path FireRedTeam/FireRed-Image-Edit-1.0 \
    --jsonl-path <数据集路径> \
    --save-path <输出目录> \
    --edit-task all \
    --seed 43 \
    --multi-folder
```

### 评估（需要 Gemini API Key）
```bash
uv run --python .venv/Scripts/python.exe tools/redbench_eval.py \
    --result_img_folder <推理结果目录> \
    --edit_json <编辑信息jsonl> \
    --prompts_json <评估提示json> \
    --num_threads 50
```

## 六、RedBench 数据格式

### JSONL 结构
```json
{
  "id": "唯一标识符",
  "task": "Add|Adjust|BG|Beauty|Color|Compose|Extract|Portrait|Low-level|Motion|Remove|Replace|Stylize|Text|Viewpoint",
  "source": "原图路径",
  "a_to_b_instructions": "中文编辑指令",
  "a_to_b_instructions_eng": "英文编辑指令"
}
```

### 15 个编辑类型
- **Add**: 添加元素
- **Adjust**: 调整属性
- **Extract**: 提取元素
- **Replace**: 替换元素
- **Remove**: 删除元素
- **BG**: 背景修改
- **Style**: 风格化
- **Beauty**: 美颜
- **Color**: 颜色调整
- **Compose**: 组合编辑
- **Portrait**: 人像编辑
- **Low-level**: 低层处理（去噪、修复）
- **Motion**: 动作编辑
- **Text**: 文字编辑
- **Viewpoint**: 视角变换

## 七、学习要点

### 1. Diffusers Pipeline 模式
```python
# 标准三步走
pipeline = QwenImageEditPlusPipeline.from_pretrained(model_id, torch_dtype=dtype)
pipeline.to("cuda")  # 必须移动到 GPU
result = pipeline(**inputs)  # 推理
```

### 2. 多进程推理（Accelerate）
```python
# tools/redbench_infer.py 的模式
accelerator = Accelerator()
pipe = pipeline.to(accelerator.device)
# 根据 rank 分发数据
```

### 3. LLM 评估体系
使用 Gemini API 自动评估图像编辑质量：
- 输入：原图 + 编辑图 + 指令
- 输出：各维度评分（1-5分）
- 特点：支持并发，50 线程并行

## 八、遇到的问题记录

### 问题 1: CUDA 不可用
```
错误: CUDA is not available or torch_xla is imported
原因: 代码硬编码 pipe.to("cuda")，没有 CPU fallback
解决: 必须使用有 NVIDIA GPU 的机器
```

### 问题 2: 模型 404 错误
```
错误: Repository Not Found: FireRedTeam/FireRed-Image-Edit-1.0
原因: 模型还未正式发布（README 标注 "To be released"）
状态: 需等待官方发布或获取访问权限
```

### 问题 3: 网络问题
```
错误: Failed to connect to github.com port 443
解决: 使用 PyPI 安装而非 git+https
命令: uv pip install diffusers transformers
```

## 九、项目文件清单

### 已创建的文档
- `CLAUDE.md` - Claude Code 工作指南
- `docs/项目学习笔记.md` - 本文档

### 原项目文件
- `README.md` - 项目说明（含 Benchmark 对比）
- `inference.py` - 推理脚本
- `tools/redbench_infer.py` - 批量推理
- `tools/redbench_eval.py` - 评估脚本
- `LICENSE` - Apache 2.0

## 十、参考资源

- **Diffusers 文档**: https://huggingface.co/docs/diffusers
- **HuggingFace Hub**: https://huggingface.co/FireRedTeam
- **Qwen-Image**: https://github.com/QwenLM/Qwen-Image

---

**备注**: 本项目适合学习 Diffusers Pipeline 的使用方式和图像编辑评估体系，但实际运行需要 GPU 环境。
